name: yamal-bistro-production

services:
  web:
    image: docker.io/hooodini/yamal-bistro-image:latest
    entrypoint: ["/app/docker/entrypoint.sh"]
    command: ["node", "server.js"]

    # Значения переменных попадут ВНУТРЬ контейнера web
    env_file:
      - ${HOME}/env/yamal-bistro-site/.env.production
      - ${HOME}/env/yamal-bistro-site/.env.local

    environment:
      # Подключение к БД по внутреннему имени сервиса
      PG_HOST: db
      PG_PORT: 5432
      DATABASE_URL: "postgresql://${PG_USER}:${PG_PASSWORD}@${PG_HOST}:${PG_PORT}/${PG_DB}?schema=public"

    expose:
      - "3000"

    depends_on:
      db:
        condition: service_healthy

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

    restart: unless-stopped

  db:
    # если базовый файл уже задаёт image/volumes — можно оставить тут только overrides
    image: postgres:18
    env_file:
      - ${HOME}/env/yamal-bistro-site/.env.production
      - ${HOME}/env/yamal-bistro-site/.env.local

    # наружу БД обычно не открываем; если нужно — закомментируй
    ports:
      - "${PG_HOST_OUT:-127.0.0.1}:${PG_PORT_OUT:-6543}:5432"

    volumes:
      - postgres-data:/var/lib/postgresql/data

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$PG_USER -d $$PG_DB -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 10

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

    restart: unless-stopped

  caddy:
    image: caddy:2.10.2-alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      ACME_AGREE: "true"

    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config

    env_file:
      - ${HOME}/env/yamal-bistro-site/.env.production

    depends_on:
      web:
        condition: service_started

    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

    restart: unless-stopped

volumes:
  postgres-data:
  caddy-data:
  caddy-config:
